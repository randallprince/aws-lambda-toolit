import{resolve as e}from"path";import{DynamoDB as t}from"aws-sdk";import{transform as r,isDate as i,isNil as s,map as n,filter as a,isEmpty as o,get as l,includes as c,pickBy as p,omit as u}from"lodash";import m from"flat";import{strict as d}from"assert";import h from"status-code-enum";const f=t=>{var r,i;try{const s=t.length>0?e(...t):e(process.cwd(),"tsconfig.json"),n=null===(i=null===(r=require(`${s}`))||void 0===r?void 0:r.compilerOptions)||void 0===i?void 0:i.paths;if(!n)throw new Error("Paths property doesn't exist in tsconfig file");return n}catch(e){if(e instanceof SyntaxError)throw new Error("Please remove all the comments from tsconfig.json file or validate it against JSON spec");throw new Error(e)}},g=(e=[])=>{const t=f(e),r={};return Object.entries(t).forEach(([e,t])=>{const i=e.replace(/(\/\*)/gi,"/(.*)");if("*"===i)throw new Error('Please remove useless path "*"');const s=`<rootDir>/${t[0].replace(/(\/\*)/gi,"/$$1")}`.replace(/\/\//,"/");r[i]=s}),r},y=(t=[])=>{const r=f(t),i={};return Object.entries(r).forEach(([t,r])=>{const s=t.replace(/(\/\*)/gi,"");if("*"===s)throw new Error('Please remove useless path "*"');const n=r[0].replace(/(\/\*)/gi,""),a=e(process.cwd(),n);i[s]=a}),i};class w extends Error{constructor(e,t){super(e),t&&(this.code=t),this.name="DynamoDBError"}}class v{constructor(e={}){this.scan=async e=>{try{return await this._docClient.scan(e).promise()}catch(e){throw new w(e,e.code)}},this.query=async e=>{try{return await this._docClient.query(e).promise()}catch(e){throw new w(e,e.code)}},this.get=async e=>{try{return await this._docClient.get(e).promise()}catch(e){throw new w(e,e.code)}},this.batchGet=async e=>{try{return await this._docClient.batchGet(e).promise()}catch(e){throw new w(e,e.code)}},this.put=async e=>{try{return await this._docClient.put(e).promise()}catch(e){throw new w(e,e.code)}},this.createSet=async e=>{try{return await this._docClient.createSet(e)}catch(e){throw new w(e,e.code)}},this.update=async e=>{try{return await this._docClient.update(e).promise()}catch(e){throw new w(e,e.code)}},this.deleteRecord=async e=>{try{return await this._docClient.delete(e).promise()}catch(e){throw new w(e,e.code)}},this._docClient=new t.DocumentClient({maxRetries:5,httpOptions:{timeout:5e3},...e})}}const E=new v,b=e=>new v(e),x=e=>{const t=m(e);return r(t,(e,t,r)=>{const s=r.replace(/(\.)(\d)/gi,"[$2]"),n=i(t)?t.toISOString():t;return e[s]=n,e},{})},_=e=>{const t=r(e,(e,t,r)=>{e.UpdateExpression||(e.UpdateExpression="SET ");const i=`#${r.replace(/(\.)|((\[)|(\]))/gi,"")}`,s=`:${r.replace(/(\.)|((\[)|(\]))/gi,"")}Value`;let n=`${i} = ${s}, `,a={};const o={[s]:t};return r.includes(".")||r.includes("[")?(r.split(".").map((e,t)=>{a[`#${e.replace(/((\[)[0-9](\]))/gi,"")}`]=r.split(".")[t].replace(/((\[)[0-9](\]))/gi,"")}),n=`#${r.replace(/(\.)/gi,".#")} = ${s}, `,e.UpdateExpression.includes(n)&&(n="")):a={[i]:r},e.UpdateExpression+=n,e.ExpressionAttributeValues={...e.ExpressionAttributeValues,...o},e.ExpressionAttributeNames={...e.ExpressionAttributeNames,...a},e});return t.UpdateExpression=t.UpdateExpression.slice(0,-2),t},k=e=>{const t=x(e);return{..._(t),flatObject:t}};const $=new class{constructor(){this.getEnvironmentVar=e=>{var t;if("string"!=typeof e)throw new Error(`${e} is not a valid environment variable`);return null!=(t=process.env[e])?t:""},this.setEnvironmentVar=(e,t)=>{if("string"!=typeof e)throw new Error(`${e} is not a valid environment variable`);if("string"!=typeof t)throw new Error(`${t} is not a valid environment variable value`);return process.env[e]=t,this.getEnvironmentVar(e)===t},this.apiBaseUrl=()=>this.getEnvironmentVar("API_BASE_URL"),this.tableName=()=>this.getEnvironmentVar("TABLE_NAME"),this.serviceName=()=>this.getEnvironmentVar("SERVICE_NAME"),this.eventName=()=>this.getEnvironmentVar("SERVICE_NAME").toUpperCase(),this.isOffline=()=>!!process.env.IS_OFFLINE}},U=()=>new Date(Date.now()).toISOString(),I=e=>{if(d(e.type,"joi schema object must have a type"),e.type&&!S[e.type])throw new Error(`sorry, do not know how to convert unknown joi type: "${e.type}"`);const t={};if(e._flags&&!s(e._flags.description)&&(t.description=e._flags.description),e._flags&&!s(e._flags.default)&&(t.default=e._flags.default),e.keys&&"function"==typeof e.keys)e=e.describe();else if(e.describe)try{e=e.describe()}catch(e){console.warn(e)}return S[e.type](t,e)},A=(e,t)=>{var r,i,s,n,l,c;return null!=(null===(i=null===(r=t)||void 0===r?void 0:r.flags)||void 0===i?void 0:i.default)&&(e.default=t.flags.default),"forbidden"===(null===(n=null===(s=t)||void 0===s?void 0:s.flags)||void 0===n?void 0:n.presence)&&(e.forbidden=!0),null!=(null===(c=null===(l=t)||void 0===l?void 0:l.flags)||void 0===c?void 0:c.label)&&(e.label=t.flags.label),t.allow&&"any"!==t.type&&(t.allow.includes(null)&&(t.allow=a(t.allow,e=>null!==e),e.type=Array.isArray(e.type)?[...e.type,"null"]:[e.type,"null"]),o(t.allow)||(e.enum=t.allow)),t.examples&&(e.examples=t.examples),e};let S={alternatives:(e,t)=>(t.matches&&(e.oneOf=[],n(t.matches,t=>{t.schema&&e.oneOf?e.oneOf.push(I(t.schema)):t.then&&e.oneOf&&e.oneOf.push(I(t.then)),t.otherwise&&e.oneOf&&e.oneOf.push(I(t.otherwise))})),e),any:(e,t)=>(e.type=["array","boolean","number","object","string","null"],A(e,t),t.allow?(t.allow.includes(null)&&(t.allow=a(t.allow,e=>null!==e)),{...e,anyOf:o(t.allow)?[{type:t.type}]:[{type:t.type,enum:t.allow}]}):e),array:(e,t)=>(e.type="array",A(e,t),t.items&&n(t.items,t=>{e.items=I(t)}),t.ordered&&(e.ordered=[],n(t.ordered,t=>{e.ordered&&e.ordered.push(I(t))})),t.rules&&n(t.rules,t=>{switch(t.name){case"min":e.minItems=l(t,"args.limit");break;case"max":e.maxItems=l(t,"args.limit");break;case"length":e.minItems=l(t,"args.limit"),e.maxItems=l(t,"args.limit");break;default:e.format=t.name||[]}}),e),binary:(e,t)=>(e.type="string",A(e,t),e.contentMediaType=t.metas&&t.metas.length>0&&t.metas[0].contentMediaType?t.metas[0].contentMediaType:"text/plain",e.contentEncoding=t.flags&&t.flags.encoding?t.flags.encoding:"binary",e),boolean:(e,t)=>(e.type="boolean",A(e,t),e),date:(e,t)=>(e.type="string",A(e,t),t.rules?n(t.rules,t=>{switch(t.name){case"min":e.minimum=l(t,"args.date");break;case"max":e.maximum=l(t,"args.date")}}):t.flags&&t.flags.format?n(t.flags,t=>{e.format=t}):e.format="date-time",e),function:(e,t)=>(e.type="function",A(e,t),e),link:(e,t)=>(e.type="link",A(e,t),t.link&&n(t.link,t=>{o(t.path)||(e.path=t.path),o(t.ancestor)||(e.ancestor=t.ancestor)}),e),number:(e,t)=>(e.type="number",A(e,t),t.rules&&n(t.rules,t=>{if(t.name)switch(t.name){case"integer":e.type="integer";break;case"less":e.exclusiveMaximum=!0,e.maximum=l(t,"args.limit");break;case"greater":e.exclusiveMinimum=!0,e.minimum=l(t,"args.limit");break;case"min":e.minimum=l(t,"args.limit");break;case"max":e.maximum=l(t,"args.limit");break;case"precision":e.precision=l(t,"args.limit");break;case"multiple":e.multiple=l(t,"args.base")}}),e),object:(e,t)=>{var r,i;return e.type="object",e.properties={},A(e,t),e.additionalProperties=Boolean(t.flags&&t.flags.unknown),"forbidden"===(null===(i=null===(r=t)||void 0===r?void 0:r.flags)||void 0===i?void 0:i.presence)&&(e.forbidden=!0),t.allow&&n(t.allow,t=>{t.value&&(c(t.value,null)&&(t.value=p(t.value,e=>null!==e),e.type=Array.isArray(e.type)?[...e.type,"null"]:[e.type,"null"]),o(t.value)||(e.enum=t.value))}),t.keys&&n(t.keys,(r,i)=>{e.properties[i]=u(t.keys[i],"keys","flags"),r.flags&&"required"===r.flags.presence&&(e.required=[],e.required.push(i)),e.properties[i]=I(r)}),e},string:(e,t)=>{var r,i;return e.type="string",A(e,t),null!=(null===(i=null===(r=t)||void 0===r?void 0:r.flags)||void 0===i?void 0:i.insensitive)&&(e.insensitive=t.flags.insensitive),t.rules&&n(t.rules,t=>{switch(t.name){case"email":e.format="email";break;case"pattern":const r=l(t,"args.regex");e.pattern=String(r).replace(/^\//,"").replace(/\/$/,""),t.args.options&&(e.format=t.args.options.name);break;case"min":e.minLength=l(t,"args.limit");break;case"max":e.maxLength=l(t,"args.limit");break;case"length":e.minLength=l(t,"args.limit"),e.maxLength=l(t,"args.limit");break;case"uri":e.format="uri";break;default:e.format=t.name||[]}}),e},symbol:(e,t)=>(e.type="symbol",A(e,t),e)};I.TYPES=S;const O=new class{constructor(){this.buildHref=(e,t)=>{if("string"!=typeof e)throw new Error("Type is not a valid string");if("string"!=typeof t)throw new Error("GUID is not a valid string");return`${this.API_BASE_URL()}/${e}/${t}`},this.buildHrefWithService=(e,t)=>{if("string"!=typeof e)throw new Error("Type is not a valid string");if("string"!=typeof t)throw new Error("GUID is not a valid string");return`${this.API_BASE_URL()}${this.EVENT_NAME()}/${e}/${t}`},this.buildIdHref=(e,t)=>{if("string"!=typeof e)throw new Error("Type is not a valid string");if("string"!=typeof t)throw new Error("guid is not a valid string");return`${this.API_BASE_URL()}/${e}/id/${t}`},this.extractId=e=>{if("string"!=typeof e)throw new Error("Href is not a valid string");const t=this.UUID_REGEX.exec(e);return t?t[1]:void 0},this.getStringId=e=>{var t;if("string"!=typeof e)throw new Error("Href is not a valid string");const r=this.UUID_REGEX.exec(e);return r?null===(t=r)||void 0===t?void 0:t[1]:""},this.validateHref=e=>{const t=new RegExp("([a-f0-9]{8}(?:-[a-f0-9]{4}){3}-[a-f0-9]{12})$","i"),r=e.split(/\//).pop();if(void 0!==r){if(null===t.exec(r))return!1}return!0},this.validateTypeGuid=(e,t)=>null!==new RegExp(`(.*)/${e.replace("/","/")}/([a-f0-9]{8}(?:-[a-f0-9]{4}){3}-[a-f0-9]{12})$`,"i").exec(t),this.validateUUID=e=>null!==this.UUID_REGEX.exec(e),this.UUID_REGEX=new RegExp(/([a-f0-9]{8}(?:-[a-f0-9]{4}){3}-[a-f0-9]{12})/i),this.API_BASE_URL=()=>$.apiBaseUrl(),this.EVENT_NAME=()=>$.eventName()}},N=e=>{if(!e)return!1;try{return JSON.parse(e),!0}catch(e){return!1}},R={statusCode:h.ClientErrorBadRequest,body:JSON.stringify({errors:[{code:"invalid.json",message:"JSON supplied to request is invalid",properties:[{property:"request.body"}]}]})};class C{constructor({code:e,message:t,properties:r}){this.code=e,this.message=t,this.properties=r}}const V=e=>({errors:e.details.map(e=>new C({code:e.type,message:e.message.replace(/"/g,""),properties:[{property:e.path.join(".")}]}))});export{w as DynamoDBError,C as JoiSchemaValidationError,I as convert,b as createDynamo,E as dynamo,_ as dynamoExpression,$ as env,x as flattenObject,V as formatValidationErrors,U as getDate,k as getDynamoExpressionWithFlat,g as getJestAliases,f as getTSConfigPaths,y as getWebpackAliases,O as href,R as invalidJsonError,N as isParseable};
